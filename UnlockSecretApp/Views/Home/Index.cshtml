@{
    Layout = null;
}
<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>💖 MiniApp — Ввод кода</title>

    <meta name="theme-color" content="#ffffff">
    <meta http-equiv="ScreenOrientation" content="autoRotate:disabled">
    <meta name="telegram-enable-debug" content="true">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/main.css" />
    <style>
        /* СПЕЦИФИЧНЫЕ СТИЛИ ДЛЯ ЭТОЙ СТРАНИЦЫ */
        html, body {
            height: 100dvh;
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: linear-gradient(160deg,#f7fbff 0%,#fef7fb 50%,#f3f9ff 100%);
            color: #7c2a8d;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .background {
            position: fixed;
            inset: 0;
            background: url('/images/background.jpg') center/cover no-repeat;
            filter: blur(12px) brightness(0.7);
            z-index: 0;
        }

        #container, .overlay {
            position: relative;
            z-index: 1;
        }

        .overlay {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: scale(0.95);
        }

            .overlay.show {
                opacity: 1;
                pointer-events: all;
                transform: scale(1);
            }

            .overlay.hidden {
                display: none;
            }

        /* ЗАГОЛОВКИ */
        .title {
            font-family: 'Great Vibes', cursive !important;
            font-size: 2.2rem;
            color: #7c2a8d;
            margin-bottom: 1rem;
            text-align: center;
        }

        .congrats-title {
            font-family: 'Great Vibes', cursive !important;
            font-size: 2rem;
            font-weight: 800;
            color: #7c2a8d;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* ФИКС ДЛЯ ТЕКСТА */
        #message {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-size: 0.95rem;
            color: rgba(124, 42, 141, 0.8);
            margin-top: 0.5rem;
            min-height: 1.5rem;
            word-wrap: break-word;
            text-align: center;
            padding: 0 0.5rem;
        }

        /* ФИКС ДЛЯ INPUT КОДА */
        .inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 1.5rem 0;
            position: relative;
            height: 65px;
        }

        input.code {
            width: 55px !important;
            height: 55px !important;
            border-radius: 12px;
            border: 2px solid rgba(180,180,200,0.4) !important;
            background: rgba(255,245,255,0.9) !important;
            font-size: 1.8rem !important;
            font-weight: 800 !important;
            color: #7c2a8d !important;
            text-align: center !important;
            padding: 0 !important;
            margin: 0 !important;
            line-height: 55px !important;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif !important;
            -webkit-appearance: none !important;
            -moz-appearance: textfield !important;
            appearance: none !important;
            box-sizing: border-box !important;
            display: inline-block !important;
            vertical-align: middle !important;
        }

            /* Убираем стрелки у числового input */
            input.code::-webkit-outer-spin-button,
            input.code::-webkit-inner-spin-button {
                -webkit-appearance: none !important;
                margin: 0 !important;
            }

            input.code[type=number] {
                -moz-appearance: textfield !important;
            }

            input.code:focus {
                outline: none !important;
                border-color: rgba(200,120,255,0.9) !important;
                background: rgba(255,240,250,0.95) !important;
                transform: scale(1.05) !important;
                position: relative;
                z-index: 2;
            }

        /* ФИКС ДЛЯ СТРАНИЦЫ 2 */
        #page2Content {
            max-height: 50vh !important;
            min-height: 200px !important;
            overflow-y: auto !important;
            width: 100% !important;
            padding: 10px 5px 10px 10px !important;
            margin: 10px 0 !important;
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
        }

            #page2Content::-webkit-scrollbar {
                width: 6px;
            }

            #page2Content::-webkit-scrollbar-track {
                background: rgba(255,255,255,0.2);
                border-radius: 3px;
            }

            #page2Content::-webkit-scrollbar-thumb {
                background: rgba(255,105,180,0.5);
                border-radius: 3px;
            }

        /* ФИКС ДЛЯ ТЕКСТА В КАЧЕСТВАХ */
        .quality-description,
        .personal-thought {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-size: 0.95rem !important;
            line-height: 1.5 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .quality-thought-item {
            margin: 0.8rem 0 !important;
            padding: 0.8rem !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        /* АДАПТАЦИЯ ДЛЯ МОБИЛЬНЫХ */
      
    </style>
</head>

<body>
    <div class="background"></div>

    <main id="container">
        <h1 class="title">Введи секретный код</h1>

        <div class="inputs" aria-label="Код">
            <input type="text" inputmode="numeric" maxlength="2" class="code" value="" />
            <input type="text" inputmode="numeric" maxlength="2" class="code" value="" />
            <input type="text" inputmode="numeric" maxlength="2" class="code" value="" />
        </div>

        <div id="kitten" title="Свайпни вправо">
            <div class="swipe-bar"></div>
            <div class="kitten-inner">🐳</div>
            <div class="arrow"></div>
            <!-- Эффекты -->
            <div class="sparkle-effect"></div>
            <div class="glow-effect"></div>
        </div>

        <div id="message">Свайпни китёнка вправо, чтобы увидеть сюрприз</div>
    </main>

    <!-- Поздравительные страницы -->
    <div id="page1" class="overlay hidden">
        <div class="congrats-card glass">
            <h2 class="congrats-title">С днём рождения 💖</h2>
            <div id="typedText" class="typing-container"></div>
            <button class="btn-next" id="next1">Далее ➡️</button>
        </div>
    </div>
    <div id="page2" class="overlay hidden">
        <div class="congrats-card glass">
            <h2 class="congrats-title">💫 То, что делает тебя особенной</h2>
            <div class="scroll-indicator">⬇️ Листай вниз</div>
            <div id="page2Content" class="qualities-thoughts-container"></div>
            <button class="btn-next" id="next2" style="display: none;">Узнать больше 🌸</button>
        </div>
    </div>
    <div id="page3" class="overlay hidden">
        <div class="congrats-card glass">
            <h2 class="congrats-title">💌 Письмо в наше будущее</h2>
            <div id="futureLetter" class="future-letter"></div>
            <button class="btn-next" id="next3" style="display: none;">Прочитать финал 🌟</button>
        </div>
    </div>

    <div id="page4" class="overlay hidden">
        <div class="congrats-card glass">
            <h2 class="congrats-title">📸 Наши моменты</h2>

            <!-- Галерея -->
            <div class="gallery-container">
                <button class="gallery-arrow gallery-arrow-prev">❮</button>

                <div class="gallery-slide">
                    <img id="galleryImage" src="" alt="Наше фото" class="gallery-image">
                    <div id="galleryCaption" class="gallery-caption"></div>
                </div>

                <button class="gallery-arrow gallery-arrow-next">❯</button>
            </div>

            <div class="gallery-indicator">
                <span id="currentIndex">1</span> / <span id="totalImages">0</span>
            </div>

            <button class="btn-next" id="next4">Завершить 🌟</button>
        </div>
    </div>

    <script>
        (() => {
            const inputs = [...document.querySelectorAll('.code')];
            const kitten = document.getElementById('kitten');
            const swipeBar = kitten.querySelector('.swipe-bar');
            const kittenInner = kitten.querySelector('.kitten-inner');
            const sparkleEffect = kitten.querySelector('.sparkle-effect');
            const glowEffect = kitten.querySelector('.glow-effect');
            const message = document.getElementById('message');
            const correctCode = ['20','05','10'];

            // ========== ИНИЦИАЛИЗАЦИЯ ВСЕХ СТРАНИЦ ==========

            // Галерея
            function initGallery() {
                const galleryData = [
                    {
                        image: 'https://via.placeholder.com/400x300/FF69B4/FFFFFF?text=Наша+первая+встреча',
                        caption: 'Наша первая встреча... Помнишь, как все начиналось? 💫'
                    },
                    {
                        image: 'https://via.placeholder.com/400x300/9370DB/FFFFFF?text=Особенные+моменты',
                        caption: 'Тот день, когда я понял - ты особенная... ✨'
                    },
                    {
                        image: 'https://via.placeholder.com/400x300/20B2AA/FFFFFF?text=Совместные+мечты',
                        caption: 'Наши совместные мечты и планы... 🌸'
                    }
                ];

                let currentGalleryIndex = 0;
                const galleryImage = document.getElementById('galleryImage');
                const galleryCaption = document.getElementById('galleryCaption');
                const currentIndexSpan = document.getElementById('currentIndex');
                const totalImagesSpan = document.getElementById('totalImages');

                totalImagesSpan.textContent = galleryData.length;

                function showGalleryImage(index, direction = 'next') {
                    const data = galleryData[index];
                    galleryImage.classList.add(direction === 'next' ? 'slide-next' : 'slide-prev');
                    galleryCaption.classList.add(direction === 'next' ? 'slide-next' : 'slide-prev');

                    galleryImage.src = data.image;
                    galleryImage.alt = `Наше фото ${index + 1}`;
                    galleryCaption.textContent = data.caption;
                    currentIndexSpan.textContent = index + 1;

                    setTimeout(() => {
                        galleryImage.classList.remove('slide-next', 'slide-prev');
                        galleryCaption.classList.remove('slide-next', 'slide-prev');
                    }, 500);
                }

                showGalleryImage(0);

                document.querySelector('.gallery-arrow-prev').addEventListener('click', () => {
                    currentGalleryIndex = (currentGalleryIndex - 1 + galleryData.length) % galleryData.length;
                    showGalleryImage(currentGalleryIndex, 'prev');
                });

                document.querySelector('.gallery-arrow-next').addEventListener('click', () => {
                    currentGalleryIndex = (currentGalleryIndex + 1) % galleryData.length;
                    showGalleryImage(currentGalleryIndex, 'next');
                });

                // Свайпы для мобильных
                let startX = 0;
                const gallerySlide = document.querySelector('.gallery-slide');

                gallerySlide.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                });

                gallerySlide.addEventListener('touchend', (e) => {
                    if (!startX) return;

                    const endX = e.changedTouches[0].clientX;
                    const diffX = startX - endX;

                    if (Math.abs(diffX) > 50) {
                        if (diffX > 0) {
                            currentGalleryIndex = (currentGalleryIndex + 1) % galleryData.length;
                            showGalleryImage(currentGalleryIndex, 'next');
                        } else {
                            currentGalleryIndex = (currentGalleryIndex - 1 + galleryData.length) % galleryData.length;
                            showGalleryImage(currentGalleryIndex, 'prev');
                        }
                    }
                    startX = 0;
                });
            }

            // Страница 4
            function showPage4WithAnimation() {
                const page4 = document.getElementById('page4');
                page4.classList.remove('hidden');
                setTimeout(() => page4.classList.add('show'), 50);
                initGallery();
            }

            // Страница 3 - письмо
            function showPage3WithAnimation() {
                const page3 = document.getElementById('page3');
                const letterContainer = document.getElementById('futureLetter');
                const nextButton = document.getElementById('next3');

                page3.classList.remove('hidden');
                setTimeout(() => page3.classList.add('show'), 50);

                nextButton.style.display = 'none';
                letterContainer.innerHTML = '';

                const letterSections = [
                    {
                        title: "📝 Начало...",
                        hiddenText: "Моя любимая... Я пишу тебе это письмо в день твоего рождения, но адресую его в наше будущее. Когда ты будешь это читать, знай — в этот момент я думаю о тебе так же сильно, как и сейчас."
                    },
                    {
                        title: "💭 О настоящем",
                        hiddenText: "Сейчас, глядя на тебя, я понимаю, как мне повезло. С каждым днем я понимал — ты не просто человек. Ты — та самая, которую я искал всю жизнь. Твоя улыбка, твой смех, твой взгляд — всё это стало для меня 'всем'. Ты — для меня та самая 'искорка', каждый момент с тобой — это подарок."
                    },
                    {
                        title: "✨ Наши мечты",
                        hiddenText: "Я верю, что нас ждут удивительные приключения."
                    },
                    {
                        title: "🛡️ Обещания",
                        hiddenText: "Я обещаю всегда быть твоей опорой. Поддерживать в любых начинаниях, верить в тебя даже когда ты сомневаешься, любить тебя сильнее с каждым днём."
                    },
                    {
                        title: "❤️ Главное",
                        hiddenText: "Ты — моё счастье, моя надежда, моя любовь. Тот человек, ради которого хочется становиться лучше. Тот свет, который освещает даже самые тёмные дни."
                    },
                    {
                        title: "💫 Будущее",
                        hiddenText: "Я не знаю, что ждёт нас впереди, но знаю точно — я хочу идти туда только с тобой. Рука об руку, сердце к сердцу. Навсегда твой..."
                    }
                ];

                let currentSection = 0;

                function createNextSection() {
                    if (currentSection < letterSections.length) {
                        const section = letterSections[currentSection];

                        const sectionElement = document.createElement('div');
                        sectionElement.className = 'letter-section';
                        sectionElement.style.opacity = '0';
                        sectionElement.style.transform = 'translateY(20px)';

                        const titleElement = document.createElement('div');
                        titleElement.className = 'letter-section-title';
                        titleElement.innerHTML = `
                            <span class="section-emoji">${section.title.split(' ')[0]}</span>
                            <span class="section-text">${section.title.substring(section.title.indexOf(' ') + 1)}</span>
                            <span class="section-arrow">▼</span>
                        `;

                        const contentElement = document.createElement('div');
                        contentElement.className = 'letter-section-content';
                        contentElement.innerHTML = section.hiddenText;
                        contentElement.style.display = 'none';

                        titleElement.addEventListener('click', () => {
                            const isOpen = contentElement.style.display === 'block';
                            contentElement.style.display = isOpen ? 'none' : 'block';
                            titleElement.querySelector('.section-arrow').textContent = isOpen ? '▼' : '▲';

                            if (!isOpen) {
                                contentElement.style.opacity = '0';
                                contentElement.style.transform = 'translateY(-10px)';
                                setTimeout(() => {
                                    contentElement.style.transition = 'all 0.4s ease';
                                    contentElement.style.opacity = '1';
                                    contentElement.style.transform = 'translateY(0)';
                                }, 10);
                            }
                        });

                        sectionElement.appendChild(titleElement);
                        sectionElement.appendChild(contentElement);
                        letterContainer.appendChild(sectionElement);

                        setTimeout(() => {
                            sectionElement.style.transition = 'all 0.8s ease';
                            sectionElement.style.opacity = '1';
                            sectionElement.style.transform = 'translateY(0)';
                        }, 100);

                        currentSection++;
                        setTimeout(createNextSection, 800);
                    } else {
                        setTimeout(() => {
                            nextButton.style.display = 'block';
                            nextButton.style.animation = 'fadeIn 0.5s ease';

                            const finalMessage = document.createElement('div');
                            finalMessage.className = 'letter-final';
                            finalMessage.innerHTML = '💖 Прочитай каждое письмо... Они все для тебя ✨';
                            letterContainer.appendChild(finalMessage);
                        }, 1000);
                    }
                }

                setTimeout(createNextSection, 500);
            }

            // Страница 2 - качества
            const page2Content = [
                {
                    emoji: "😊",
                    title: "Твоя улыбка",
                    description: "Когда ты улыбаешься, все проблемы отступают. Твоя улыбка уникальна.",
                    thought: "Твоя улыбка стала для меня праздником среди обыденности."
                },
                {
                    emoji: "💫",
                    title: "Моя искорка",
                    description: "Ты зажгла во мне огонь, о котором я даже не мечтал.",
                    thought: "Ты превратила моё существование в настоящую жизнь."
                },
                {
                    emoji: "🤗",
                    title: "Твоя забота",
                    description: "Ты всегда чувствуешь, когда мне тяжело, и находишь нужные слова.",
                    thought: "Твоя поддержка - мой якорь в трудные моменты."
                }
            ];

            function showPage2WithAnimation() {
                const page2 = document.getElementById('page2');
                const contentContainer = document.getElementById('page2Content');
                const nextButton = document.getElementById('next2');

                page2.classList.remove('hidden');
                setTimeout(() => page2.classList.add('show'), 50);

                nextButton.style.display = 'none';
                contentContainer.innerHTML = '';

                // Устанавливаем правильные шрифты
                const fixFonts = () => {
                    const descriptions = contentContainer.querySelectorAll('.quality-description');
                    const thoughts = contentContainer.querySelectorAll('.personal-thought');

                    descriptions.forEach(el => {
                        el.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
                        el.style.fontSize = "0.95rem";
                        el.style.lineHeight = "1.5";
                        el.style.wordWrap = "break-word";
                    });

                    thoughts.forEach(el => {
                        el.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
                        el.style.fontSize = "0.9rem";
                        el.style.lineHeight = "1.5";
                        el.style.wordWrap = "break-word";
                    });
                };

                // Добавляем элементы с задержкой
                page2Content.forEach((item, index) => {
                    setTimeout(() => {
                        const qualityItem = document.createElement('div');
                        qualityItem.className = 'quality-thought-item';
                        qualityItem.innerHTML = `
                            <div class="quality-header">
                                <span class="quality-emoji">${item.emoji}</span>
                                <div class="quality-title">${item.title}</div>
                            </div>
                            <div class="quality-description">${item.description}</div>
                            <div class="personal-thought">${item.thought}</div>
                        `;

                        contentContainer.appendChild(qualityItem);

                        setTimeout(() => {
                            qualityItem.classList.add('visible');
                            fixFonts();

                            // Скроллим к последнему элементу
                            if (index === page2Content.length - 1) {
                                setTimeout(() => {
                                    nextButton.style.display = 'block';
                                    nextButton.style.animation = 'fadeIn 0.5s ease';

                                    // Добавляем слушатель скролла для кнопки
                                    const checkScroll = () => {
                                        const container = contentContainer;
                                        const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 10;

                                        if (isAtBottom) {
                                            nextButton.style.display = 'block';
                                            nextButton.style.animation = 'fadeIn 0.5s ease';
                                            container.removeEventListener('scroll', checkScroll);
                                        }
                                    };

                                    contentContainer.addEventListener('scroll', checkScroll);
                                }, 800);
                            }
                        }, 100);

                    }, index * 800);
                });
            }

            // Страница 1 - печатная машинка
            function typeWriter(text, element, speed = 40, callback = null) {
                let i = 0;
                element.innerHTML = '';

                function type() {
                    if (i < text.length) {
                        if (text.substring(i, i + 6) === '<wait>') {
                            i += 6;
                            setTimeout(type, 500);
                            return;
                        }

                        if (text.substring(i, i + 8) === '<number>') {
                            i += 8;
                            const numEnd = text.indexOf('</number>', i);
                            if (numEnd !== -1) {
                                const number = text.substring(i, numEnd);
                                element.innerHTML += `<span class="highlight-number">${number}</span>`;
                                i = numEnd + 9;
                            }
                        } else {
                            element.innerHTML += text.charAt(i);
                            i++;
                        }

                        const cursor = document.createElement('span');
                        cursor.className = 'typed-cursor';
                        element.appendChild(cursor);

                        setTimeout(() => {
                            if (cursor.parentNode) {
                                cursor.parentNode.removeChild(cursor);
                            }
                            type();
                        }, speed);
                    } else {
                        if (callback) callback();
                    }
                }
                type();
            }

            const page1Content = `За этими цифрами — наша история...<wait>

        Каждое число хранит воспоминания:<wait>

               <number>20</number> 🌙<wait>
        День, когда вселенная подмигнула<wait>
        Наши первые "привет", встречи, взгляды<wait>

        <number>05</number> 💫<wait>
        День, когда судьба сказала "да"<wait>
        День, когда ты стала моей половинкой<wait>

        <number>10</number> 💖<wait>
        День, когда тишина закричала любовью<wait>
        День, когда сердце перестало молчать<wait>


        Готова продолжить? 💫`;

            function showPage1WithAnimation() {
                const page1 = document.getElementById('page1');
                const typedText = document.getElementById('typedText');
                const nextButton = document.getElementById('next1');

                page1.classList.remove('hidden');
                setTimeout(() => page1.classList.add('show'), 50);

                nextButton.style.display = 'none';

                // Фиксируем шрифт для печатной машинки
                typedText.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
                typedText.style.fontSize = "1rem";
                typedText.style.lineHeight = "1.6";

                typeWriter(page1Content, typedText, 30, () => {
                    setTimeout(() => {
                        nextButton.style.display = 'block';
                        nextButton.style.animation = 'fadeIn 0.5s ease';
                    }, 500);
                });
            }

            // ========== ОБРАБОТЧИКИ КНОПОК ==========
            document.getElementById("next1").addEventListener('click', () => showPage2WithAnimation());
            document.getElementById("next2").addEventListener('click', () => showPage3WithAnimation());
            document.getElementById("next3").addEventListener('click', () => showPage4WithAnimation());
            document.getElementById("next4").addEventListener('click', () => {
                alert('Спасибо, что прошла весь этот путь со мной! 💖');
            });

            // ========== ФИКСЫ ДЛЯ INPUT ==========
            function fixInputs() {
                inputs.forEach((inp, i) => {
                    // Принудительно устанавливаем стили
                    inp.style.fontFamily = "'Segoe UI', system-ui, -apple-system, sans-serif";
                    inp.style.fontSize = "1.8rem";
                    inp.style.fontWeight = "800";
                    inp.style.lineHeight = inp.offsetHeight + "px";
                    inp.style.textAlign = "center";
                    inp.style.padding = "0";
                    inp.style.margin = "0";

                    inp.addEventListener('focus', () => {
                        if (inp.value === '00') inp.value = '';
                        inp.style.lineHeight = inp.offsetHeight + "px";
                    });

                    inp.addEventListener('blur', () => {
                        if (inp.value === '') inp.value = '00';
                    });

                    inp.addEventListener('input', e => {
                        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 2);
                        e.target.style.lineHeight = e.target.offsetHeight + "px";

                        if (e.target.value.length === 2 && i < inputs.length - 1) {
                            setTimeout(() => inputs[i + 1].focus(), 10);
                        }

                        if (e.target.value.length > 0) {
                            e.target.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                if (e.target) e.target.style.transform = 'scale(1)';
                            }, 150);
                        }
                    });

                    inp.addEventListener('keydown', e => {
                        if (e.key === 'Backspace' && e.target.value === '' && i > 0) {
                            setTimeout(() => inputs[i - 1].focus(), 10);
                        }
                    });
                });

                // Пересчитываем line-height при изменении размера
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        inputs.forEach(inp => {
                            if (inp.offsetHeight > 0) {
                                inp.style.lineHeight = inp.offsetHeight + "px";
                            }
                        });
                    }, 100);
                });
            }

            // ========== SWIPE HANDLING ==========
            let startX = 0;
            let isSwiping = false;
            let animationFrameId = null;

            const handleSwipeMove = (e) => {
                if (!isSwiping || startX === 0) return;

                const dx = Math.max(0, e.clientX - startX);
                const progress = Math.min(100, dx / 1.5);

                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                animationFrameId = requestAnimationFrame(() => {
                    swipeBar.style.width = progress + '%';
                    kittenInner.style.left = Math.min(dx / 1.5, 120) + 'px';
                    glowEffect.style.width = progress + '%';
                    sparkleEffect.style.opacity = Math.min(progress / 100, 0.7);

                    if (progress > 70 && progress % 20 < 5) {
                        createParticlesAroundKitten();
                    }
                });
            };

            kitten.addEventListener('pointerdown', e => {
                startX = e.clientX;
                isSwiping = true;
                kitten.setPointerCapture(e.pointerId);
                kitten.style.cursor = 'grabbing';
                kitten.classList.remove('ready-pulse');
                createWave(e.clientX, e.clientY);
                kitten.addEventListener('pointermove', handleSwipeMove);
            });

            kitten.addEventListener('pointerup', (e) => {
                if (!isSwiping) return;
                kitten.removeEventListener('pointermove', handleSwipeMove);

                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }

                const dx = e.clientX - startX;

                if (dx > 100) {
                    const userCode = inputs.map(inp => inp.value.padStart(2, '0'));

                    if (!userCode.every((v, i) => v === correctCode[i])) {
                        wrongCodeAnimation();
                    } else {
                        correctCodeAnimation();
                    }
                } else {
                    resetSwipeWithAnimation();
                }

                isSwiping = false;
                startX = 0;
            });

            kitten.addEventListener('pointercancel', () => {
                if (isSwiping) {
                    kitten.removeEventListener('pointermove', handleSwipeMove);
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    resetSwipeWithAnimation();
                    isSwiping = false;
                    startX = 0;
                }
            });

            // ========== ANIMATIONS ==========
            function createParticles(element) {
                const rect = element.getBoundingClientRect();
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.left = rect.left + rect.width / 2 + 'px';
                        particle.style.top = rect.top + rect.height / 2 + 'px';
                        particle.style.setProperty('--tx', (Math.random() - 0.5) * 40 + 'px');
                        particle.style.setProperty('--ty', (Math.random() - 0.5) * 40 + 'px');
                        particle.style.background = i % 2 === 0 ? '#ff69b4' : '#9370db';
                        document.body.appendChild(particle);

                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.parentNode.removeChild(particle);
                            }
                        }, 800);
                    }, i * 100);
                }
            }

            function createParticlesAroundKitten() {
                const rect = kitten.getBoundingClientRect();
                for (let i = 0; i < 2; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = rect.right - 20 + 'px';
                    particle.style.top = rect.top + Math.random() * rect.height + 'px';
                    particle.style.setProperty('--tx', (Math.random() * 30 + 10) + 'px');
                    particle.style.setProperty('--ty', (Math.random() - 0.5) * 30 + 'px');
                    particle.style.background = '#ff69b4';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 800);
                }
            }

            function createWave(x, y) {
                const wave = document.createElement('div');
                wave.className = 'wave';
                wave.style.left = x + 'px';
                wave.style.top = y + 'px';
                document.body.appendChild(wave);

                setTimeout(() => {
                    if (wave.parentNode) {
                        wave.parentNode.removeChild(wave);
                    }
                }, 400);
            }

            function correctCodeAnimation() {
                message.textContent = 'Ура! Правильно! 💖';
                kitten.classList.add('success-glow');
                createParticlesAroundKitten();
                inputs.forEach(inp => inp.blur());

                setTimeout(() => {
                    document.getElementById('container').classList.add('fade-out-scale');
                    setTimeout(() => showPage1WithAnimation(), 500);
                }, 1000);
            }

            function wrongCodeAnimation() {
                message.textContent = 'Неверный код! Попробуй ещё 🌸';
                kitten.classList.add('shake');
                setTimeout(() => kitten.classList.remove('shake'), 500);
                resetSwipeWithAnimation();
            }

            function resetSwipeWithAnimation() {
                swipeBar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                kittenInner.style.transition = 'left 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                glowEffect.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                sparkleEffect.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                swipeBar.style.width = '0%';
                kittenInner.style.left = '10px';
                glowEffect.style.width = '0%';
                sparkleEffect.style.opacity = '0';

                setTimeout(() => {
                    swipeBar.style.transition = '';
                    kittenInner.style.transition = '';
                    glowEffect.style.transition = '';
                    sparkleEffect.style.transition = '';
                    kitten.style.cursor = 'pointer';
                    kitten.classList.add('ready-pulse');
                }, 300);
            }

            // ========== ИНИЦИАЛИЗАЦИЯ ==========
            kitten.classList.add('ready-pulse');
            fixInputs();

            // Функция для фикса всех шрифтов
            function fixAllFonts() {
                // Фиксируем шрифты для сообщений
                message.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";

                // Фиксируем шрифты в inputs
                inputs.forEach(inp => {
                    inp.style.fontFamily = "'Segoe UI', system-ui, -apple-system, sans-serif";
                });

                // Фиксируем шрифты в кнопках
                const buttons = document.querySelectorAll('.btn-next');
                buttons.forEach(btn => {
                    btn.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
                });

                // Фиксируем заголовки
                const titles = document.querySelectorAll('.title, .congrats-title');
                titles.forEach(title => {
                    title.style.fontFamily = "'Great Vibes', cursive";
                });
            }

            // Запускаем все фиксы
            setTimeout(() => {
                fixAllFonts();
                fixInputs();
                setTimeout(() => inputs[0].focus(), 200);
            }, 100);

        })();
    </script>
</body>
</html>